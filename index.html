<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiskers & Wonders: Pip's Culinary Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Firebase configuration from user query
        const firebaseConfig = {
            apiKey: "AIzaSyBSPbMCpsZdQ3o5wp5X_QI_HZicXfuZFE0",
            authDomain: "pipthechef.firebaseapp.com",
            projectId: "pipthechef",
            storageBucket: "pipthechef.firebasestorage.app",
            messagingSenderId: "380947665181",
            appId: "1:380947665181:web:5488ccbd5fad97b8fb11f4",
            measurementId: "G-GRNXVKZR3S"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for Firebase instances and user data
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.currentUserId = null;
        window.isPremiumMember = false;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Use __app_id from Canvas

        // Stripe Payment Link ID from user query
        window.stripePaymentLink = "https://buy.stripe.com/plink_1RmZMbLOZKHisj8AQQHnnCuR"; // Using the provided payment link

        // Helper function for messages (GLOBAL)
        function showMessage(msg, type) {
            const msgBox = document.getElementById('globalMessageBox');
            msgBox.textContent = msg;
            msgBox.className = `p-3 rounded-lg text-center font-semibold mt-4 ${type === 'error' ? 'bg-red-100 text-red-700' : type === 'success' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`;
            msgBox.style.display = 'block';
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, 3000);
        }

        // Recipe data (GLOBAL)
        const recipeData = {
            'brownies': {
                totalSteps: 4,
                currentStep: 1,
                containerId: 'brownies-recipe',
                stepsContainerId: 'steps-container-brownies',
                isPremium: false
            },
            'pancakes': {
                totalSteps: 5,
                currentStep: 1,
                containerId: 'pancakes-recipe',
                stepsContainerId: 'steps-container-pancakes',
                isPremium: false
            },
            'mochi-donuts': {
                totalSteps: 5,
                currentStep: 1,
                containerId: 'mochi-donuts-recipe',
                stepsContainerId: 'steps-container-mochi-donuts',
                isPremium: true
            },
            'cheesecake': {
                totalSteps: 5,
                currentStep: 1,
                containerId: 'cheesecake-recipe',
                stepsContainerId: 'steps-container-cheesecake',
                isPremium: true
            },
            'blueberry-waffles': {
                totalSteps: 5,
                currentStep: 1,
                containerId: 'blueberry-waffles-recipe',
                stepsContainerId: 'steps-container-blueberry-waffles',
                isPremium: true
            },
            'hamburger': {
                totalSteps: 5,
                currentStep: 1,
                containerId: 'hamburger-recipe',
                stepsContainerId: 'steps-container-hamburger',
                isPremium: true
            },
            'fried-chicken': {
                totalSteps: 5,
                currentStep: 1,
                containerId: 'fried-chicken-recipe',
                stepsContainerId: 'steps-container-fried-chicken',
                isPremium: true
            }
            // Removed 'culinary-quest-game' from recipeData
        };

        let activeRecipeId = null; // Track which recipe is currently active
        let profileView; // Global reference for profile view
        let recipeContainer; // Global reference for recipe container

        // Function to update recipe access based on membership status (GLOBAL)
        function updateRecipeAccess() {
            const recipeLinks = document.querySelectorAll('.post-thumbnail, .highlight-circle');
            recipeLinks.forEach(link => {
                const recipeId = link.dataset.recipe;
                // Define premium recipes (removed game from here)
                const premiumRecipes = ['mochi-donuts', 'cheesecake', 'blueberry-waffles', 'hamburger', 'fried-chicken'];
                
                // Remove existing click handlers to prevent duplicates
                link.onclick = null; 
                link.removeEventListener('click', handleRecipeLinkClick); // Remove previous dynamic listener if exists

                if (premiumRecipes.includes(recipeId) && !window.isPremiumMember) {
                    link.classList.add('opacity-50', 'cursor-not-allowed');
                    link.addEventListener('click', (e) => { // Add new restricted handler
                        e.preventDefault();
                        showMessage("Upgrade to Premium to unlock this recipe!", "error");
                    });
                } else {
                    link.classList.remove('opacity-50', 'cursor-not-allowed');
                    // Add the original navigation handler
                    link.addEventListener('click', handleRecipeLinkClick);
                }
            });
        }

        // Centralized handler for recipe link clicks (GLOBAL)
        function handleRecipeLinkClick(event) {
            const link = event.currentTarget; // Use currentTarget to get the element the event listener is attached to
            const recipeId = link.dataset.recipe;
            if (recipeId) {
                // Ensure profileView and recipeContainer are defined before use
                const currentProfileView = document.getElementById('profile-view');
                const currentRecipeContainer = document.getElementById('recipe-container');
                
                // Hide all recipe views first
                document.querySelectorAll('.recipe-view > div').forEach(div => div.classList.add('hidden'));
                
                // Show the selected recipe view
                const targetRecipeDiv = document.getElementById(`${recipeId}-recipe`);
                if (targetRecipeDiv) {
                    targetRecipeDiv.classList.remove('hidden');
                    currentRecipeContainer.classList.add('active');
                    currentProfileView.classList.remove('active');
                    
                    // No special game initialization needed here anymore
                    if (recipeData[recipeId]) {
                        // For regular recipes, update their view
                        updateRecipeView(recipeId);
                    }
                } else {
                    console.error(`Recipe div not found for ID: ${recipeId}-recipe`);
                }
            }
        }

        // Function to update individual recipe step view (GLOBAL)
        function updateRecipeView(recipeId) {
            const recipe = recipeData[recipeId];
            const stepsContainer = document.getElementById(recipe.stepsContainerId);
            const stepPanels = stepsContainer.querySelectorAll('.step-panel');
            const prevBtn = stepsContainer.closest('.bg-amber-100').querySelector('.prev-btn');
            const nextBtn = stepsContainer.closest('.bg-amber-100').querySelector('.next-btn');
            const stepIndicator = stepsContainer.closest('.bg-amber-100').querySelector('.step-indicator');

            stepPanels.forEach(panel => {
                panel.classList.remove('active');
                const video = panel.querySelector('video');
                if (video) {
                    video.pause();
                    video.currentTime = 0;
                }
            });

            const activePanel = stepsContainer.querySelector(`#${recipeId}-step-${recipe.currentStep}`);
            if (activePanel) {
                activePanel.classList.add('active');
                const activeVideo = activePanel.querySelector('video');
                if (activeVideo) {
                    activeVideo.play();
                }
            }
            
            stepIndicator.textContent = `Step ${recipe.currentStep} of ${recipe.totalSteps}`;

            prevBtn.disabled = (recipe.currentStep === 1);
            nextBtn.textContent = (recipe.currentStep === recipe.totalSteps) ? 'Finish!' : 'Next';
        }


        // Listen for auth state changes
        onAuthStateChanged(auth, async (user) => {
            const userIdDisplay = document.getElementById('userIdDisplay');
            const membershipStatusDisplay = document.getElementById('membershipStatusDisplay');
            const authButtons = document.getElementById('authButtons');
            const activateMembershipBtn = document.getElementById('activateMembershipBtn');
            const confirmMembershipBtn = document.getElementById('confirmMembershipBtn');
            
            const loginSignupMessage = document.getElementById('loginSignupMessage');

            if (user) {
                window.currentUserId = user.uid;
                userIdDisplay.textContent = `Logged in as: ${user.isAnonymous ? 'Anonymous' : user.email}`;
                authButtons.innerHTML = `<button id="signOutBtn" class="btn bg-red-500 hover:bg-red-600">Sign Out</button>`;
                document.getElementById('signOutBtn').addEventListener('click', handleSignOut);

                // Check membership status in Firestore
                const userProfileRef = doc(db, `artifacts/${window.appId}/users/${user.uid}/profile/membership`);
                onSnapshot(userProfileRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().status === 'premium') {
                        window.isPremiumMember = true;
                        membershipStatusDisplay.textContent = 'Status: Premium Member ✨';
                        activateMembershipBtn.style.display = 'none';
                        confirmMembershipBtn.style.display = 'none';
                        loginSignupMessage.textContent = ''; // Clear message
                    } else {
                        window.isPremiumMember = false;
                        membershipStatusDisplay.textContent = 'Status: Free User';
                        activateMembershipBtn.style.display = 'inline-block';
                        confirmMembershipBtn.style.display = 'none'; // Hide confirm until payment link is visited
                        loginSignupMessage.textContent = 'Upgrade to unlock all recipes!';
                    }
                    // Call updateRecipeAccess here as it depends on window.isPremiumMember
                    updateRecipeAccess(); 
                }, (error) => {
                    console.error("Error listening to membership status:", error);
                    window.isPremiumMember = false;
                    membershipStatusDisplay.textContent = 'Status: Free User (Error loading status)';
                    updateRecipeAccess();
                });

            } else {
                window.currentUserId = null;
                window.isPremiumMember = false;
                userIdDisplay.textContent = 'Not logged in.';
                membershipStatusDisplay.textContent = 'Status: Free User';
                authButtons.innerHTML = `
                    <input type="email" id="emailInput" placeholder="Email" class="p-2 rounded-md border border-gray-300 w-full sm:w-auto mb-2 sm:mb-0">
                    <input type="password" id="passwordInput" placeholder="Password" class="p-2 rounded-md border border-gray-300 w-full sm:w-auto mb-2 sm:mb-0">
                    <button id="signUpBtn" class="btn bg-blue-500 hover:bg-blue-600">Sign Up</button>
                    <button id="loginBtn" class="btn bg-green-500 hover:bg-green-600">Log In</button>
                `;
                document.getElementById('signUpBtn').addEventListener('click', handleSignUp);
                document.getElementById('loginBtn').addEventListener('click', handleLogin);
                activateMembershipBtn.style.display = 'none'; // Only show after anonymous login
                confirmMembershipBtn.style.display = 'none';
                loginSignupMessage.textContent = 'Sign in or sign up to save your progress and access premium features.';

                // Authenticate using __initial_auth_token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        showMessage("Signed in with custom token.", "info");
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        showMessage("Failed to sign in with custom token. Please sign in manually.", "error");
                    }
                } else {
                    // Do not automatically sign in anonymously if no custom token.
                    // User must explicitly sign up/log in.
                    showMessage("Please sign in or sign up to continue.", "info");
                }
            }
        });

        async function handleSignUp() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) {
                showMessage("Please enter email and password.", "error");
                return;
            }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                // Create a basic profile in Firestore for the new user
                const userProfileRef = doc(db, `artifacts/${window.appId}/users/${user.uid}/profile/membership`);
                await setDoc(userProfileRef, { status: 'free', createdAt: new Date() });
                showMessage("Signed up and logged in successfully!", "success");
            } catch (error) {
                console.error("Error signing up:", error);
                showMessage(`Sign Up Failed: ${error.message}`, "error");
            }
        }

        async function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) {
                showMessage("Please enter email and password.", "error");
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Logged in successfully!", "success");
            } catch (error) {
                console.error("Error logging in:", error);
                showMessage(`Login Failed: ${error.message}`, "error");
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                showMessage("Signed out successfully!", "info");
            } catch (error) {
                console.error("Error signing out:", error);
                showMessage(`Sign Out Failed: ${error.message}`, "error");
            }
        }

        async function handleActivateMembership() {
            if (!window.currentUserId) {
                showMessage("Please sign in or sign up first!", "error");
                return;
            }
            if (window.isPremiumMember) {
                showMessage("You are already a premium member!", "info");
                return;
            }

            // Redirect to Stripe payment link
            window.open(window.stripePaymentLink, '_blank');

            // Show "Confirm Membership" button after redirection
            document.getElementById('confirmMembershipBtn').style.display = 'inline-block';
            showMessage("Please complete your purchase on Stripe. Then click 'Confirm Membership Activation' here.", "info");
        }

        async function handleConfirmMembership() {
            if (!window.currentUserId) {
                showMessage("You must be signed in to confirm membership.", "error");
                return;
            }
            if (window.isPremiumMember) {
                showMessage("You are already a premium member!", "info");
                return;
            }

            try {
                const userProfileRef = doc(db, `artifacts/${window.appId}/users/${window.currentUserId}/profile/membership`);
                await setDoc(userProfileRef, { status: 'premium', activatedAt: new Date() }, { merge: true });
                showMessage("Membership activated! Welcome, Premium Chef!", "success");
                document.getElementById('confirmMembershipBtn').style.display = 'none'; // Hide button after activation
            } catch (error) {
                console.error("Error confirming membership:", error);
                showMessage(`Failed to activate membership: ${error.message}`, "error");
            }
        }

        
    </script>
</body>
</html>
